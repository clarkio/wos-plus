---
import "../styles/wos-plus-streamer.css";
import WosBaseLayout from "../layouts/WosBaseLayout.astro";
import Twitch from "../components/Icons/Twitch.astro";
import SettingsDialog from "../components/SettingsDialog.astro";
import MadeBy from "../components/MadeBy.astro";
---

<WosBaseLayout
  title="WoS+ | Words on Stream Plus - Streamer"
  description="WoS+ | Words on Stream Plus - Streamer - An enhanced interface for streamers playing Words on Stream with Twitch chat integration and customizable settings."
  keywords="clarkio, words on stream, wos, twitch, streaming, helper, wordsonstream, tool, wos plus, streamer"
>
  <SettingsDialog id="streamer-settings" title="Streamer Settings">
    <form id="streamer-settings-form" class="settings-form">
      <div class="form-group">
        <label for="streamer-mirror-url-input">Mirror URL</label>
        <input
          type="url"
          id="streamer-mirror-url-input"
          name="mirrorUrl"
          placeholder="https://wos.gg/r/game-mirror-value-here"
          required
        />
        <small class="form-help"
          >The URL to the Words on Stream game mirror</small
        >
      </div>
      <div class="form-group">
        <label for="streamer-twitch-channel-input">Twitch Channel</label>
        <input
          type="text"
          id="streamer-twitch-channel-input"
          name="twitchChannel"
          placeholder="clarkio"
          required
        />
        <small class="form-help">The Twitch channel name to connect to</small>
      </div>
      <div class="form-group">
        <label class="toggle-label">
          <input
            type="checkbox"
            id="streamer-clear-sound-input"
            name="clearSound"
            class="toggle-input"
            checked
          />
          <span class="toggle-slider"></span>
          <span class="toggle-text">Play Clear Sound</span>
        </label>
        <small class="form-help"
          >Play a sound when all words are found on a level</small
        >
      </div>
    </form>
  </SettingsDialog>

  <div class="streamer-wos-main-grid">
    <div class="streamer-wos-board-container" id="wos-board">
      <iframe id="streamer-wos-board-iframe" src="" loading="lazy"></iframe>
    </div>
    <div class="streamer-channel-data-container">
      <div id="overlay" class="overlay">
        <div id="level-current" class="level-current">
          <span id="level-title" class="level-title">LEVEL</span>
          <span id="level-value" class="level-value"></span>
        </div>
        <div id="level-record-container" class="level-record-container">
          <div class="level-record">
            <span class="icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="75%"
                height="75%"
                viewBox="0 0 24 24"
                preserveAspectRatio="xMidYMid meet"
                fill="currentcolor"
              >
                <path
                  d="M12 6a7 7 0 1 0 0 14 7 7 0 0 0 0-14zm1 8h-2V8h2v6z"
                  opacity=".3"></path>
                <path d="M9 1h6v2H9z"></path>
                <path
                  d="m19 7 1-1-1-1-1 1a9 9 0 0 0-15 7 9 9 0 1 0 16-6zm-7 13a7 7 0 1 1 0-14 7 7 0 0 1 0 14z"
                ></path>
                <path d="M11 8h2v6h-2z"></path>
              </svg>
            </span>
            <span id="pb-value" class="level-record-value"></span>
          </div>
          <div class="level-record">
            <span class="icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="75%"
                height="75%"
                viewBox="0 0 24 24"
                preserveAspectRatio="xMidYMid meet"
                fill="currentcolor"
              >
                <path fill="none" d="M0 0h24v24H0z"></path>
                <path d="M12 14c-2 0-3-1-3-3V5h6v6c0 2-1 3-3 3z" opacity=".3"
                ></path>
                <path
                  d="M19 5h-2V3H7v2H5L3 7v1c0 3 2 5 4 5 1 1 2 3 4 3v3H7v2h10v-2h-4v-3c2 0 3-2 4-3 2 0 4-2 4-5V7l-2-2zM5 8V7h2v4L5 8zm7 6c-2 0-3-1-3-3V5h6v6c0 2-1 3-3 3zm7-6-2 3V7h2v1z"
                ></path>
              </svg>
            </span>
            <span id="daily-pb-value" class="level-record-value"></span>
          </div>
          <div class="level-record">
            <span class="icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="75%"
                height="75%"
                viewBox="0 0 24 24"
                preserveAspectRatio="xMidYMid meet"
                fill="currentcolor"
              >
                <path
                  d="M19.36 2.72L20.78 4.14L15.06 9.85C16.13 11.39 16.28 13.24 15.38 14.44L9.06 8.12C10.26 7.22 12.11 7.37 13.65 8.44L19.36 2.72M5.93 17.57C3.92 15.56 2.69 13.16 2.35 10.92L7.23 8.83L14.67 16.27L12.58 21.15C10.34 20.81 7.94 19.58 5.93 17.57Z"
                ></path>
              </svg>
            </span>
            <span id="daily-clear-value" class="level-record-value"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="streamer-twitch-chat-frame">
      <iframe id="streamer-twitch-chat-widget" src=""></iframe>
    </div>
    <div class="streamer-bottom-container">
      <div id="streamer-correct-words-log-container">
        <div class="correct-words-header">
          <span>Correct Words: (*missed words)</span>
          <MadeBy />
        </div>
        <div id="correct-words-log" class="correct-words-log">
          <!-- <div class='word-group'>
            <div class='word-group__title'>4:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>5:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>6:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>DOGIES</span>
              <span class='correct-word'>GOODIE</span>
              <span class='correct-word'>GOOSED</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>7:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>GOODIES</span>
              <span class='correct-word'>GOODIES</span>
              <span class='correct-word'>GOODIES</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>8:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>AGOODIES</span>
              <span class='correct-word'>AGOODIES</span>
              <span class='correct-word'>AGOODIES</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>9:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>AAGOODIES</span>
              <span class='correct-word'>AAGOODIES</span>
              <span class='correct-word'>AAGOODIES</span>
            </div>
          </div> -->
        </div>
      </div>
      <div class="streamer-level-data-grid-container">
        <div class="level-data-container">
          <div>
            <span id="letters-label" class="letters-label">Letters:</span>
            <span id="letters" class="letters"></span>
          </div>
          <div>
            <span id="hidden-letter-label" class="hidden-letter-label"
              >Hidden Letters:</span
            >
            <span id="hidden-letter" class="hidden-letter"></span>
          </div>
          <div>
            <span id="fake-letter-label" class="fake-letter-label"
              >Fake Letters:</span
            >
            <span id="fake-letter" class="fake-letter"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</WosBaseLayout>

<script>
  import { GameSpectator } from "../scripts/wos-plus-main";

  const boardContainer = document.getElementById(
    "wos-board",
  ) as HTMLDivElement | null;
  const boardIframe = document.getElementById(
    "streamer-wos-board-iframe",
  ) as HTMLIFrameElement | null;
  let currentMirrorUrl = "";
  let twitchChannel = "clarkio";

  const normalizeMirrorUrl = (input: string): string => {
    const trimmed = input.trim();
    // If it already starts with http:// or https://, return as-is
    if (trimmed.startsWith("http://") || trimmed.startsWith("https://")) {
      return trimmed;
    }
    // Otherwise, prepend the base URL
    return `https://wos.gg/r/${trimmed}`;
  };

  const isBoardVisible = () =>
    boardContainer
      ? window.getComputedStyle(boardContainer).display !== "none"
      : true;

  const loadBoardIframeIfVisible = () => {
    if (!boardIframe || !currentMirrorUrl || !isBoardVisible()) {
      return;
    }

    if (boardIframe.getAttribute("src") !== currentMirrorUrl) {
      boardIframe.setAttribute("src", currentMirrorUrl);
    }
  };

  const clearBoardIframe = () => {
    if (!boardIframe) {
      return;
    }

    if (boardIframe.hasAttribute("src")) {
      boardIframe.removeAttribute("src");
    }
  };

  const spectator = new GameSpectator();

  // Initialize dialog API reference
  let settingsDialog: any = null;

  const initializeSettingsDialog = (event?: Event) => {
    const dialog = document.getElementById(
      "streamer-settings",
    ) as HTMLDialogElement;

    if (dialog && (dialog as any).__api) {
      settingsDialog = (dialog as any).__api;
    }
  };

  // Separate function to set up save callback
  const setupDialogCallbacks = () => {
    if (!settingsDialog) return;

    // Set up save callback
    settingsDialog.onSave((data: Record<string, any>) => {
      const params = new URLSearchParams(window.location.search);

      if (data.mirrorUrl) {
        params.set("mirrorUrl", data.mirrorUrl);
      }
      if (data.twitchChannel) {
        params.set("twitchChannel", data.twitchChannel);
      }
      // Handle clear sound toggle
      params.set("clearSound", data.clearSound ? "true" : "false");

      // Reload the page with new parameters
      window.location.href = window.location.pathname + "?" + params.toString();
    });
  };

  const checkRequiredParams = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const hasMirrorUrl = urlParams.has("mirrorUrl");
    const hasTwitchChannel = urlParams.has("twitchChannel");

    // If either parameter is missing, show the settings dialog
    if (!hasMirrorUrl || !hasTwitchChannel) {
      // Pre-populate any existing values
      if (hasMirrorUrl) {
        const mirrorUrlInput = document.getElementById(
          "streamer-mirror-url-input",
        ) as HTMLInputElement;
        if (mirrorUrlInput) {
          mirrorUrlInput.value = urlParams.get("mirrorUrl") || "";
        }
      }

      if (hasTwitchChannel) {
        const twitchChannelInput = document.getElementById(
          "streamer-twitch-channel-input",
        ) as HTMLInputElement;
        if (twitchChannelInput) {
          twitchChannelInput.value = urlParams.get("twitchChannel") || "";
        }
      }

      // Pre-populate clear sound checkbox
      const clearSoundInput = document.getElementById(
        "streamer-clear-sound-input",
      ) as HTMLInputElement;
      if (clearSoundInput) {
        const clearSoundParam = urlParams.get("clearSound");
        clearSoundInput.checked = clearSoundParam
          ? clearSoundParam.toLowerCase() === "true"
          : true;
      }

      // Ensure dialog is ready and set up callbacks before opening
      const attemptOpenDialog = () => {
        const dialog = document.getElementById(
          "streamer-settings",
        ) as HTMLDialogElement;
        if (dialog && (dialog as any).__api) {
          settingsDialog = (dialog as any).__api;
          setupDialogCallbacks();
          settingsDialog.open();
        } else {
          // If dialog not ready, try again shortly
          setTimeout(attemptOpenDialog, 50);
        }
      };

      setTimeout(attemptOpenDialog, 100);

      return false;
    }

    return true;
  };

  // Function to initialize the page
  const initializePage = () => {
    // Reset dialog reference on each navigation
    settingsDialog = null;

    // Initialize settings dialog
    const dialog = document.getElementById(
      "streamer-settings",
    ) as HTMLDialogElement;
    if (dialog) {
      // Try to get the API immediately if it exists
      if ((dialog as any).__api) {
        settingsDialog = (dialog as any).__api;
      } else {
        // If not ready yet, wait for the event
        dialog.addEventListener("dialog-ready", initializeSettingsDialog, {
          once: true,
        });
      }
    }

    // check for query parameters in the url
    const urlParams = new URLSearchParams(window.location.search);

    // Check if required parameters are present (this will trigger dialog if needed)
    const hasRequiredParams = checkRequiredParams();
    if (urlParams.has("mirrorUrl")) {
      const url = urlParams.get("mirrorUrl") || "";
      currentMirrorUrl = normalizeMirrorUrl(url);
      loadBoardIframeIfVisible();
      console.log(currentMirrorUrl);
    }

    if (urlParams.has("chat")) {
      const isChatEnabled = urlParams.get("chat")?.toLowerCase() === "true";
      const twitchChatWidget = document.getElementById(
        "streamer-twitch-chat-widget",
      ) as HTMLIFrameElement;
      const grid = document.querySelector(
        ".streamer-wos-main-grid",
      ) as HTMLElement;
      if (isChatEnabled) {
        twitchChatWidget.style.display = "";
        grid.classList.remove("chat-hidden");
      } else {
        twitchChatWidget.style.display = "none";
        grid.classList.add("chat-hidden");
      }
    }

    if (urlParams.has("twitchChannel")) {
      twitchChannel = urlParams.get("twitchChannel") || "clarkio";
      const twitchChatWidget = document.getElementById(
        "streamer-twitch-chat-widget",
      ) as HTMLIFrameElement;
      twitchChatWidget.src = `https://www.twitch.tv/embed/${twitchChannel}/chat?darkpopout&parent=${location.hostname}`;
    }

    // Only connect if we have required parameters
    if (hasRequiredParams) {
      // Handle clear sound setting
      if (urlParams.has("clearSound")) {
        spectator.clearSoundEnabled =
          urlParams.get("clearSound")?.toLowerCase() === "true";
      }

      spectator.connectToWosGame(currentMirrorUrl);
      spectator.connectToTwitch(twitchChannel);
    }

    if (urlParams.has("board")) {
      const boardEnabled = urlParams.get("board")?.toLowerCase() === "true";
      if (boardContainer) {
        if (boardEnabled) {
          boardContainer.style.display = "";
          loadBoardIframeIfVisible();
        } else {
          boardContainer.style.display = "none";
          clearBoardIframe();
        }
      }
    } else {
      loadBoardIframeIfVisible();
    }
  };

  // Listen for both events to handle initial load and navigation
  document.addEventListener("DOMContentLoaded", initializePage);
  document.addEventListener("astro:page-load", initializePage);
</script>

<!-- Styles provided by wos-shared.css via wos-plus-streamer.css import -->
