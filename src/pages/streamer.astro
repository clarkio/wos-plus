---
import '../styles/wos-plus-streamer.css';
import WosBaseLayout from '../layouts/WosBaseLayout.astro';
import Twitch from '../components/Icons/Twitch.astro';
import SettingsDialog from '../components/SettingsDialog.astro';
import Settings from '../components/Icons/Settings.astro';

export const prerender = false;

// Get session from middleware (guaranteed to exist on protected routes)
const session = Astro.locals.session;

// Check for login success
const url = new URL(Astro.request.url);
const loginSuccess = url.searchParams.get('login_success') === 'true';
---

<WosBaseLayout
  title="WoS+ | Words on Stream Plus - Streamer"
  description="WoS+ | Words on Stream Plus - Streamer - An enhanced interface for streamers playing Words on Stream with Twitch chat integration and customizable settings."
  keywords='clarkio, words on stream, wos, twitch, streaming, helper, wordsonstream, tool, wos plus, streamer'
>
  <SettingsDialog id='streamer-settings' title='Streamer Settings'>
    <form id='streamer-settings-form' class='settings-form'>
      <div class='form-group'>
        <label for='streamer-mirror-url-input'>Mirror URL</label>
        <input
          type='url'
          id='streamer-mirror-url-input'
          name='mirrorUrl'
          placeholder='https://wos.gg/r/game-mirror-value-here'
          required
        />
        <small class='form-help'
          >The URL to the Words on Stream game mirror</small
        >
      </div>
      <div class='form-group'>
        <label for='streamer-twitch-channel-input'>Twitch Channel</label>
        <input
          type='text'
          id='streamer-twitch-channel-input'
          name='twitchChannel'
          placeholder='clarkio'
          required
        />
        <small class='form-help'>The Twitch channel name to connect to</small>
      </div>
      <div class='form-group'>
        <label class='toggle-label'>
          <input
            type='checkbox'
            id='streamer-chat-enabled-input'
            name='chatEnabled'
            class='toggle-input'
          />
          <span class='toggle-slider'></span>
          <span class='toggle-text'>Show Twitch Chat</span>
        </label>
        <small class='form-help'>Toggle Twitch chat visibility</small>
      </div>
      <div class='form-group'>
        <label class='toggle-label'>
          <input
            type='checkbox'
            id='streamer-wos-enabled-input'
            name='wosEnabled'
            class='toggle-input'
            checked
          />
          <span class='toggle-slider'></span>
          <span class='toggle-text'>Show Words on Stream Board</span>
        </label>
        <small class='form-help'>Toggle the Words on Stream board visibility</small>
      </div>
      <div class='form-group'>
        <label class='toggle-label'>
          <input
            type='checkbox'
            id='streamer-clear-sound-input'
            name='clearSound'
            class='toggle-input'
            checked
          />
          <span class='toggle-slider'></span>
          <span class='toggle-text'>Play Clear Sound</span>
        </label>
        <small class='form-help'>Play a sound when all words are found on a level</small>
      </div>
    </form>
  </SettingsDialog>

  {/* Login success toast */}
  {loginSuccess && session && (
    <div class="welcome-toast" id="welcome-toast">
      <img src={session.profileImageUrl} alt="" class="toast-avatar" />
      <div class="toast-content">
        <span class="toast-title">Welcome, {session.displayName}!</span>
        <span class="toast-message">You're now logged in with Twitch</span>
      </div>
      <button class="toast-close" id="toast-close" aria-label="Dismiss">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  )}

  <div class='streamer-wos-main-grid'>
    <div class='streamer-wos-board-container' id='wos-board'>
      <iframe id='streamer-wos-board-iframe' src='' loading='lazy'></iframe>
    </div>
    <div class='streamer-channel-data-container'>
      <div class="channel-menu" data-channel-menu>
        <button
          type="button"
          class="channel-menu__button"
          data-channel-menu-button
          aria-label="Open menu"
          aria-haspopup="true"
          aria-expanded="false"
          title="Menu"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="5" r="1.5"></circle>
            <circle cx="12" cy="12" r="1.5"></circle>
            <circle cx="12" cy="19" r="1.5"></circle>
          </svg>
        </button>

        <div class="channel-menu__dropdown" data-channel-menu-dropdown hidden>
          {session && (
            <div class="channel-menu__user">
              <img src={session.profileImageUrl} alt="" class="channel-menu__avatar" loading="lazy" />
              <div class="channel-menu__userText">
                <div class="channel-menu__name">{session.displayName}</div>
                <div class="channel-menu__hint">Logged in with Twitch</div>
              </div>
            </div>
          )}

          <button
            id="open-settings-btn"
            type="button"
            class="channel-menu__item"
            data-channel-menu-close
          >
            <Settings size={18} />
            <span>Settings</span>
          </button>

          <button
            id="generate-obs-url-btn"
            type="button"
            class="channel-menu__item"
            data-channel-menu-close
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M10 13a5 5 0 0 0 7.07 0l1.41-1.41a5 5 0 0 0-7.07-7.07L10 4.86"></path>
              <path d="M14 11a5 5 0 0 0-7.07 0L5.52 12.4a5 5 0 0 0 7.07 7.07L14 19.14"></path>
            </svg>
            <span>Copy OBS Browser Source URL</span>
          </button>

          <button
            id="regenerate-obs-url-btn"
            type="button"
            class="channel-menu__item"
            data-channel-menu-close
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M21 12a9 9 0 1 1-2.64-6.36"></path>
              <polyline points="21 3 21 9 15 9"></polyline>
            </svg>
            <span>Regenerate OBS URL</span>
          </button>

          <a href="/" class="channel-menu__item" data-channel-menu-close>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M3 10.5L12 3l9 7.5"></path>
              <path d="M5 10v10a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1V10"></path>
            </svg>
            <span>Home</span>
          </a>

          {session && (
            <a href="/api/auth/logout" class="channel-menu__item channel-menu__logout" data-channel-menu-close>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              <span>Logout</span>
            </a>
          )}
        </div>
      </div>

      <div id='overlay' class='overlay'>
        <div id='level-current' class='level-current'>
          <span id='level-title' class='level-title'>LEVEL</span>
          <span id='level-value' class='level-value'></span>
        </div>
        <div id='level-record-container' class='level-record-container'>
          <div class='level-record'>
            <span class='icon'>
              <svg
                xmlns='http://www.w3.org/2000/svg'
                width='75%'
                height='75%'
                viewBox='0 0 24 24'
                preserveAspectRatio='xMidYMid meet'
                fill='currentcolor'
              >
                <path
                  d='M12 6a7 7 0 1 0 0 14 7 7 0 0 0 0-14zm1 8h-2V8h2v6z'
                  opacity='.3'></path>
                <path d='M9 1h6v2H9z'></path>
                <path
                  d='m19 7 1-1-1-1-1 1a9 9 0 0 0-15 7 9 9 0 1 0 16-6zm-7 13a7 7 0 1 1 0-14 7 7 0 0 1 0 14z'
                ></path>
                <path d='M11 8h2v6h-2z'></path>
              </svg>
            </span>
            <span id='pb-value' class='level-record-value'></span>
          </div>
          <div class='level-record'>
            <span class='icon'>
              <svg
                xmlns='http://www.w3.org/2000/svg'
                width='75%'
                height='75%'
                viewBox='0 0 24 24'
                preserveAspectRatio='xMidYMid meet'
                fill='currentcolor'
              >
                <path fill='none' d='M0 0h24v24H0z'></path>
                <path d='M12 14c-2 0-3-1-3-3V5h6v6c0 2-1 3-3 3z' opacity='.3'
                ></path>
                <path
                  d='M19 5h-2V3H7v2H5L3 7v1c0 3 2 5 4 5 1 1 2 3 4 3v3H7v2h10v-2h-4v-3c2 0 3-2 4-3 2 0 4-2 4-5V7l-2-2zM5 8V7h2v4L5 8zm7 6c-2 0-3-1-3-3V5h6v6c0 2-1 3-3 3zm7-6-2 3V7h2v1z'
                ></path>
              </svg>
            </span>
            <span id='daily-pb-value' class='level-record-value'></span>
          </div>
          <div class='level-record'>
            <span class='icon'>
              <svg
                xmlns='http://www.w3.org/2000/svg'
                width='75%'
                height='75%'
                viewBox='0 0 24 24'
                preserveAspectRatio='xMidYMid meet'
                fill='currentcolor'
              >
                <path
                  d='M19.36 2.72L20.78 4.14L15.06 9.85C16.13 11.39 16.28 13.24 15.38 14.44L9.06 8.12C10.26 7.22 12.11 7.37 13.65 8.44L19.36 2.72M5.93 17.57C3.92 15.56 2.69 13.16 2.35 10.92L7.23 8.83L14.67 16.27L12.58 21.15C10.34 20.81 7.94 19.58 5.93 17.57Z'
                ></path>
              </svg>
            </span>
            <span id='daily-clear-value' class='level-record-value'></span>
          </div>
        </div>
      </div>
    </div>
    <div class='streamer-twitch-chat-frame'>
      <iframe id='streamer-twitch-chat-widget' src=''></iframe>
    </div>
    <div class='streamer-bottom-container'>
      <div id='streamer-correct-words-log-container'>
        <span>Correct Words: (* potential words missed)</span>
        <div id='correct-words-log' class='correct-words-log'>
          <!-- <div class='word-group'>
            <div class='word-group__title'>4:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
              <span class='correct-word'>DOGS</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>5:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
              <span class='correct-word'>DOGES</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>6:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>DOGIES</span>
              <span class='correct-word'>GOODIE</span>
              <span class='correct-word'>GOOSED</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>7:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>GOODIES</span>
              <span class='correct-word'>GOODIES</span>
              <span class='correct-word'>GOODIES</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>8:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>AGOODIES</span>
              <span class='correct-word'>AGOODIES</span>
              <span class='correct-word'>AGOODIES</span>
            </div>
          </div>
          <div class='word-group'>
            <div class='word-group__title'>9:</div><div
              class='word-group__words'
            >
              <span class='correct-word'>AAGOODIES</span>
              <span class='correct-word'>AAGOODIES</span>
              <span class='correct-word'>AAGOODIES</span>
            </div>
          </div> -->
        </div>
      </div>
      <div class='streamer-level-data-grid-container'>
        <div class='level-data-container'>
          <div>
            <span id='letters-label' class='letters-label'>Letters:</span>
            <span id='letters' class='letters'></span>
          </div>
          <div>
            <span id='hidden-letter-label' class='hidden-letter-label'
              >Hidden Letters:</span
            >
            <span id='hidden-letter' class='hidden-letter'></span>
          </div>
          <div>
            <span id='fake-letter-label' class='fake-letter-label'
              >Fake Letters:</span
            >
            <span id='fake-letter' class='fake-letter'></span>
          </div>
          <span class='made-by'>Made by: <Twitch /> clarkio</span>
        </div>
      </div>
    </div>
  </div>
</WosBaseLayout>

<script>
  import { GameSpectator } from '../scripts/wos-plus-main';

  const boardContainer = document.getElementById(
    'wos-board'
  ) as HTMLDivElement | null;
  const boardIframe = document.getElementById(
    'streamer-wos-board-iframe'
  ) as HTMLIFrameElement | null;
  let currentMirrorUrl = '';
  let twitchChannel = 'clarkio';

  const normalizeMirrorUrl = (input: string): string => {
    const trimmed = input.trim();
    // If it already starts with http:// or https://, return as-is
    if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) {
      return trimmed;
    }
    // Otherwise, prepend the base URL
    return `https://wos.gg/r/${trimmed}`;
  };

  const isBoardVisible = () =>
    boardContainer
      ? window.getComputedStyle(boardContainer).display !== 'none'
      : true;

  const loadBoardIframeIfVisible = () => {
    if (!boardIframe || !currentMirrorUrl || !isBoardVisible()) {
      return;
    }

    if (boardIframe.getAttribute('src') !== currentMirrorUrl) {
      boardIframe.setAttribute('src', currentMirrorUrl);
    }
  };

  const clearBoardIframe = () => {
    if (!boardIframe) {
      return;
    }

    if (boardIframe.hasAttribute('src')) {
      boardIframe.removeAttribute('src');
    }
  };

  const spectator = new GameSpectator();
  const populateSettingsFormFromUrl = (urlParams: URLSearchParams) => {
    const mirrorUrlInput = document.getElementById(
      'streamer-mirror-url-input'
    ) as HTMLInputElement | null;
    const twitchChannelInput = document.getElementById(
      'streamer-twitch-channel-input'
    ) as HTMLInputElement | null;
    const clearSoundInput = document.getElementById(
      'streamer-clear-sound-input'
    ) as HTMLInputElement | null;
    const chatEnabledInput = document.getElementById(
      'streamer-chat-enabled-input'
    ) as HTMLInputElement | null;
    const wosEnabledInput = document.getElementById(
      'streamer-wos-enabled-input'
    ) as HTMLInputElement | null;

    if (mirrorUrlInput && urlParams.has('mirrorUrl')) {
      mirrorUrlInput.value = urlParams.get('mirrorUrl') || '';
    }

    if (twitchChannelInput && urlParams.has('twitchChannel')) {
      twitchChannelInput.value = urlParams.get('twitchChannel') || '';
    }

    if (clearSoundInput) {
      const clearSoundParam = urlParams.get('clearSound');
      clearSoundInput.checked = clearSoundParam
        ? clearSoundParam.toLowerCase() === 'true'
        : true;
    }

    if (chatEnabledInput) {
      const chatParam = urlParams.get('chat');
      chatEnabledInput.checked = chatParam
        ? chatParam.toLowerCase() === 'true'
        : true;
    }

    if (wosEnabledInput) {
      const boardParam = urlParams.get('board');
      wosEnabledInput.checked = boardParam
        ? boardParam.toLowerCase() === 'true'
        : true;
    }
  };


  // Initialize dialog API reference
  let settingsDialog: any = null;

  const initializeSettingsDialog = (event?: Event) => {
    const dialog = document.getElementById(
      'streamer-settings'
    ) as HTMLDialogElement;

    if (dialog && (dialog as any).__api) {
      settingsDialog = (dialog as any).__api;
    }
  };

  // Separate function to set up save callback
  const setupDialogCallbacks = () => {
    if (!settingsDialog) return;

    // Set up save callback
    settingsDialog.onSave((data: Record<string, any>) => {
      const params = new URLSearchParams(window.location.search);

      if (data.mirrorUrl) {
        params.set('mirrorUrl', data.mirrorUrl);
      }
      if (data.twitchChannel) {
        params.set('twitchChannel', data.twitchChannel);
      }
      // Handle clear sound toggle
      params.set('clearSound', data.clearSound ? 'true' : 'false');

      // Handle chat enabled toggle
      params.set('chat', data.chatEnabled ? 'true' : 'false');

      // Handle WoS board visibility toggle
      params.set('board', data.wosEnabled ? 'true' : 'false');

      // Reload the page with new parameters
      window.location.href = window.location.pathname + '?' + params.toString();
    });
  };

  const checkRequiredParams = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const hasMirrorUrl = urlParams.has('mirrorUrl');
    const hasTwitchChannel = urlParams.has('twitchChannel');

    // If either parameter is missing, show the settings dialog
    if (!hasMirrorUrl || !hasTwitchChannel) {
      // Pre-populate any existing values
      populateSettingsFormFromUrl(urlParams);

      // Ensure dialog is ready and set up callbacks before opening
      const attemptOpenDialog = () => {
        const dialog = document.getElementById('streamer-settings') as HTMLDialogElement;
        if (dialog && (dialog as any).__api) {
          settingsDialog = (dialog as any).__api;
          setupDialogCallbacks();
          settingsDialog.open();
        } else {
          // If dialog not ready, try again shortly
          setTimeout(attemptOpenDialog, 50);
        }
      };

      setTimeout(attemptOpenDialog, 100);

      return false;
    }

    return true;
  };

  // Function to initialize the page
  const initializePage = () => {
    // Reset dialog reference on each navigation
    settingsDialog = null;

    // Handle welcome toast close button and auto-dismiss
    const welcomeToast = document.getElementById('welcome-toast');
    const toastClose = document.getElementById('toast-close');
    if (welcomeToast && toastClose) {
      toastClose.addEventListener('click', () => {
        welcomeToast.style.display = 'none';
      });
      // Auto-remove after animation completes (5 seconds)
      setTimeout(() => {
        if (welcomeToast) welcomeToast.remove();
      }, 5000);
      // Clean up login_success param from URL without reload
      const cleanUrl = new URL(window.location.href);
      cleanUrl.searchParams.delete('login_success');
      window.history.replaceState({}, '', cleanUrl.toString());
    }

    // Initialize settings dialog
    const dialog = document.getElementById('streamer-settings') as HTMLDialogElement;
    if (dialog) {
      // Try to get the API immediately if it exists
      if ((dialog as any).__api) {
        settingsDialog = (dialog as any).__api;
        setupDialogCallbacks();
      } else {
        // If not ready yet, wait for the event
        dialog.addEventListener(
          'dialog-ready',
          (event) => {
            initializeSettingsDialog(event);
            setupDialogCallbacks();
          },
          { once: true }
        );
      }
    }

    // Init menu button + dropdown behavior
    const initChannelMenus = () => {
      const menus = document.querySelectorAll('[data-channel-menu]');
      if (menus.length === 0) return;

      const closeAllMenus = () => {
        menus.forEach((menu) => {
          const button = menu.querySelector('[data-channel-menu-button]') as HTMLButtonElement | null;
          const dropdown = menu.querySelector('[data-channel-menu-dropdown]') as HTMLElement | null;
          if (!button || !dropdown) return;
          dropdown.hidden = true;
          button.setAttribute('aria-expanded', 'false');
        });
      };

      menus.forEach((menu) => {
        const button = menu.querySelector('[data-channel-menu-button]') as HTMLButtonElement | null;
        const dropdown = menu.querySelector('[data-channel-menu-dropdown]') as HTMLElement | null;
        if (!button || !dropdown) return;

        if ((button as any).__wosInit) return;
        (button as any).__wosInit = true;

        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = button.getAttribute('aria-expanded') === 'true';
          closeAllMenus();
          dropdown.hidden = isOpen;
          button.setAttribute('aria-expanded', (!isOpen).toString());
        });

        menu.addEventListener('click', (e) => {
          const target = e.target as HTMLElement | null;
          if (!target) return;
          const shouldClose = !!target.closest('[data-channel-menu-close]');
          if (shouldClose) {
            closeAllMenus();
          }
        });
      });

      const win = window as any;
      if (!win.__wosChannelMenuGlobalListeners) {
        win.__wosChannelMenuGlobalListeners = true;
        document.addEventListener('click', (e) => {
          const target = e.target as Node;
          const clickedInMenu = Array.from(document.querySelectorAll('[data-channel-menu]')).some((m) =>
            m.contains(target)
          );
          if (!clickedInMenu) closeAllMenus();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeAllMenus();
        });
      }
    };
    initChannelMenus();

    // Set up settings button click handler (now inside the menu)
    const settingsBtn = document.getElementById('open-settings-btn');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        if (!settingsDialog && dialog && (dialog as any).__api) {
          settingsDialog = (dialog as any).__api;
          setupDialogCallbacks();
        }
        if (settingsDialog) {
          const urlParams = new URLSearchParams(window.location.search);
          populateSettingsFormFromUrl(urlParams);
          settingsDialog.open();
        }
      });
    }

    type ObsUrlHandlerConfig = {
      button: HTMLButtonElement;
      endpoint: string;
      payload: unknown;
      generatingLabel: string;
      defaultLabel: string;
      successClipboardMessage: string;
      errorAlertMessage: string;
      consoleErrorPrefix: string;
      promptMessage: string;
    };

    async function handleObsUrlRequest(config: ObsUrlHandlerConfig): Promise<void> {
      const {
        button,
        endpoint,
        payload,
        generatingLabel,
        defaultLabel,
        successClipboardMessage,
        errorAlertMessage,
        consoleErrorPrefix,
        promptMessage,
      } = config;

      const labelEl = button.querySelector('span') as HTMLSpanElement | null;
      const originalText = labelEl?.textContent || defaultLabel;

      button.disabled = true;
      if (labelEl) labelEl.textContent = generatingLabel;

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload ?? {}),
        });

        if (!response.ok) {
          const text = await response.text().catch(() => '');
          throw new Error(text || `Request failed: ${response.status}`);
        }

        const data: { token?: string; url?: string } = await response.json();
        const token = data.token;
        const apiUrl = data.url;

        const buildUrlWithTokenAndSettings = (tokenValue: string): string => {
          const currentUrl = new URL(window.location.href);
          const finalUrl = new URL(window.location.origin + window.location.pathname);
          const params = new URLSearchParams(currentUrl.search);

          // Remove one-time params
          params.delete('login_success');

          // Ensure required settings exist on the URL. If they aren't on the URL yet,
          // fall back to the current Settings dialog input values.
          const mirrorInput = document.getElementById('streamer-mirror-url-input') as HTMLInputElement | null;
          const twitchInput = document.getElementById('streamer-twitch-channel-input') as HTMLInputElement | null;
          const clearSoundInput = document.getElementById('streamer-clear-sound-input') as HTMLInputElement | null;
          const chatEnabledInput = document.getElementById('streamer-chat-enabled-input') as HTMLInputElement | null;
          const wosEnabledInput = document.getElementById('streamer-wos-enabled-input') as HTMLInputElement | null;

          if (!params.has('mirrorUrl') && mirrorInput?.value) {
            params.set('mirrorUrl', mirrorInput.value);
          }
          if (!params.has('twitchChannel') && twitchInput?.value) {
            params.set('twitchChannel', twitchInput.value);
          }
          if (!params.has('clearSound') && clearSoundInput) {
            params.set('clearSound', clearSoundInput.checked ? 'true' : 'false');
          }
          if (!params.has('chat') && chatEnabledInput) {
            params.set('chat', chatEnabledInput.checked ? 'true' : 'false');
          }
          if (!params.has('board') && wosEnabledInput) {
            params.set('board', wosEnabledInput.checked ? 'true' : 'false');
          }

          params.set('obs', tokenValue);
          finalUrl.search = params.toString();
          return finalUrl.toString();
        };

        // Prefer token-based reconstruction so we keep existing query params.
        let url: string | undefined;
        if (token) {
          url = buildUrlWithTokenAndSettings(token);
        } else {
          url = apiUrl;
        }

        if (!url) throw new Error('Missing URL in response');

        try {
          await navigator.clipboard.writeText(url);
          window.alert(successClipboardMessage);
        } catch {
          // Fallback for non-secure contexts / blocked clipboard APIs
          window.prompt(promptMessage, url);
        }
      } catch (err) {
        console.error(consoleErrorPrefix, err);
        window.alert(errorAlertMessage);
      } finally {
        button.disabled = false;
        if (labelEl) labelEl.textContent = originalText;
      }
    }

    // Generate/copy OBS URL (long-lived, token-based)
    const obsBtn = document.getElementById('generate-obs-url-btn') as HTMLButtonElement | null;
    if (obsBtn && !(obsBtn as any).__wosObsInit) {
      (obsBtn as any).__wosObsInit = true;
      obsBtn.addEventListener('click', () => {
        void handleObsUrlRequest({
          button: obsBtn,
          endpoint: '/api/obs/session',
          payload: {},
          generatingLabel: 'Generating…',
          defaultLabel: 'Copy OBS Browser Source URL',
          successClipboardMessage: 'OBS Browser Source URL copied to clipboard.',
          errorAlertMessage: 'Failed to generate OBS URL. Make sure you are logged in, then try again.',
          consoleErrorPrefix: 'Failed to generate OBS URL:',
          promptMessage: 'Copy this OBS Browser Source URL:',
        });
      });
    }

    // Regenerate OBS URL (rotates token; old URLs stop working)
    const regenObsBtn = document.getElementById('regenerate-obs-url-btn') as HTMLButtonElement | null;
    if (regenObsBtn && !(regenObsBtn as any).__wosObsRegenInit) {
      (regenObsBtn as any).__wosObsRegenInit = true;
      regenObsBtn.addEventListener('click', async () => {
        const confirmed = window.confirm(
          'Regenerate OBS URL? This will invalidate the previous OBS link you may have already added to OBS.'
        );
        if (!confirmed) return;

        const labelEl = regenObsBtn.querySelector('span') as HTMLSpanElement | null;
        const originalText = labelEl?.textContent || 'Regenerate OBS URL';
        regenObsBtn.disabled = true;
        if (labelEl) labelEl.textContent = 'Regenerating…';

        try {
          const response = await fetch('/api/obs/session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ regenerate: true }),
          });

          if (!response.ok) {
            const text = await response.text().catch(() => '');
            throw new Error(text || `Request failed: ${response.status}`);
          }

          const data: { token?: string; url?: string } = await response.json();
          const token = data.token;
          const apiUrl = data.url;

          let url: string | undefined;
          if (token) {
            // Match the generate flow by reusing the shared URL builder.
            url = buildUrlWithTokenAndSettings(token);
          } else {
            url = apiUrl;
          }

          if (!url) throw new Error('Missing URL in response');

          try {
            await navigator.clipboard.writeText(url);
            window.alert('New OBS Browser Source URL copied to clipboard.');
          } catch {
            window.prompt('Copy this new OBS Browser Source URL:', url);
          }
        } catch (err) {
          console.error('Failed to regenerate OBS URL:', err);
          window.alert('Failed to regenerate OBS URL. Make sure you are logged in, then try again.');
        } finally {
          regenObsBtn.disabled = false;
          if (labelEl) labelEl.textContent = originalText;
        }
      });
    }

    // check for query parameters in the url
    const urlParams = new URLSearchParams(window.location.search);

    // Check if required parameters are present (this will trigger dialog if needed)
    const hasRequiredParams = checkRequiredParams();
    if (urlParams.has('mirrorUrl')) {
      const url = urlParams.get('mirrorUrl') || '';
      currentMirrorUrl = normalizeMirrorUrl(url);
      loadBoardIframeIfVisible();
      console.log(currentMirrorUrl);
    }

    if (urlParams.has('chat')) {
      const isChatEnabled = urlParams.get('chat')?.toLowerCase() === 'true';
      const twitchChatWidget = document.getElementById(
        'streamer-twitch-chat-widget'
      ) as HTMLIFrameElement;
      const grid = document.querySelector(
        '.streamer-wos-main-grid'
      ) as HTMLElement;
      if (isChatEnabled) {
        twitchChatWidget.style.display = '';
        grid.classList.remove('chat-hidden');
      } else {
        twitchChatWidget.style.display = 'none';
        grid.classList.add('chat-hidden');
      }
    }

    if (urlParams.has('twitchChannel')) {
      twitchChannel = urlParams.get('twitchChannel') || 'clarkio';
      const twitchChatWidget = document.getElementById(
        'streamer-twitch-chat-widget'
      ) as HTMLIFrameElement;
      twitchChatWidget.src = `https://www.twitch.tv/embed/${twitchChannel}/chat?darkpopout&parent=${location.hostname}`;
    }

    // Only connect if we have required parameters
    if (hasRequiredParams) {
      // Handle clear sound setting
      if (urlParams.has('clearSound')) {
        spectator.clearSoundEnabled = urlParams.get('clearSound')?.toLowerCase() === 'true';
      }

      spectator.connectToWosGame(currentMirrorUrl);
      spectator.connectToTwitch(twitchChannel);
    }

    if (urlParams.has('board')) {
      const boardEnabled = urlParams.get('board')?.toLowerCase() === 'true';
      if (boardContainer) {
        if (boardEnabled) {
          boardContainer.style.display = '';
          loadBoardIframeIfVisible();
        } else {
          boardContainer.style.display = 'none';
          clearBoardIframe();
        }
      }
    } else {
      loadBoardIframeIfVisible();
    }
  };

  // Listen for both events to handle initial load and navigation
  document.addEventListener('DOMContentLoaded', initializePage);
  document.addEventListener('astro:page-load', initializePage);
</script>

<style>
  /* Override wrapper max-width when in widget mode */
  :global(.widget-mode .wrapper) {
    max-width: 100% !important;
    padding: 0 !important;
  }

  /* Settings form styles */
  .settings-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    color: var(--text-lightest, #f5efff);
    font-weight: 600;
    font-size: 0.95rem;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 0.75rem;
    border: 1px solid var(--border-primary, rgba(199, 156, 255, 0.4));
    border-radius: 6px;
    background: var(--bg-tertiary, #4b1a81);
    color: var(--text-primary, #dacfe6);
    font-size: 1rem;
    font-family: var(--font-main, 'Inter', sans-serif);
    transition: all 0.2s ease;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--accent-violet, #c79cff);
    background: var(--bg-dark, #161625);
  }

  .form-group input::placeholder {
    color: rgba(218, 207, 230, 0.5);
  }

  .form-help {
    color: rgba(218, 207, 230, 0.7);
    font-size: 0.85rem;
    font-style: italic;
  }

  /* Toggle switch styles */
  .toggle-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    position: relative;
  }

  .toggle-input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
    background: var(--bg-tertiary, #4b1a81);
    border: 2px solid var(--border-primary, rgba(199, 156, 255, 0.4));
    border-radius: 26px;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    left: 2px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--text-primary, #dacfe6);
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .toggle-input:checked + .toggle-slider {
    background: var(--bg-secondary, #7736c6);
    border-color: var(--accent-violet, #c79cff);
  }

  .toggle-input:checked + .toggle-slider::before {
    left: 26px;
    background: var(--text-lightest, #f5efff);
  }

  .toggle-input:focus + .toggle-slider {
    box-shadow: 0 0 0 3px rgba(199, 156, 255, 0.3);
  }

  .toggle-text {
    color: var(--text-lightest, #f5efff);
    font-weight: 600;
    font-size: 0.95rem;
  }

  /* Streamer header actions moved into menu dropdown */

  /* Welcome toast styles */
  .welcome-toast {
    position: fixed;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: linear-gradient(135deg, #9146FF 0%, #7c3aed 100%);
    border: 1px solid rgba(199, 156, 255, 0.5);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(145, 70, 255, 0.4);
    z-index: 1000;
    animation: slideDown 0.4s ease-out, fadeOut 0.3s ease-in 4.7s forwards;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
      visibility: hidden;
    }
  }

  .toast-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  .toast-content {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .toast-title {
    font-weight: 600;
    color: #fff;
    font-size: 0.95rem;
  }

  .toast-message {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.8);
  }

  .toast-close {
    background: none;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.7);
    transition: color 0.2s;
    margin-left: 0.5rem;
  }

  .toast-close:hover {
    color: #fff;
  }

  .toast-close svg {
    width: 18px;
    height: 18px;
  }
</style>
